
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>CSRF対策 · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.19">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro-fixed/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
  <script defer data-domain="fintan-contents.github.io,all.fintan" src=https://plausible.io/js/script.js></script>

    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="../auth/e2e/" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    この資料について
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../intro/">
            
                <a href="../intro/">
            
                    
                    はじめに
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../setup/">
            
                <a href="../setup/">
            
                    
                    ハンズオンの準備
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../setup/install/">
            
                <a href="../setup/install/">
            
                    
                    開発環境の準備
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../setup/download/">
            
                <a href="../setup/download/">
            
                    
                    資料のダウンロード
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../todo-spec/">
            
                <a href="../todo-spec/">
            
                    
                    ToDoアプリの仕様説明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../todo-project/">
            
                <a href="../todo-project/">
            
                    
                    ToDoアプリプロジェクトの作成
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../todo-project/project/">
            
                <a href="../todo-project/project/">
            
                    
                    プロジェクトの作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../todo-project/frontend/">
            
                <a href="../todo-project/frontend/">
            
                    
                    フロントエンドの確認
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../todo-project/backend/">
            
                <a href="../todo-project/backend/">
            
                    
                    バックエンドの確認
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../todo/">
            
                <a href="../todo/">
            
                    
                    ToDo管理の実装
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../todo/frontend/">
            
                <a href="../todo/frontend/">
            
                    
                    フロントエンド
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="../todo/frontend/todo-page/">
            
                <a href="../todo/frontend/todo-page/">
            
                    
                    ページ外観の作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="../todo/frontend/component/">
            
                <a href="../todo/frontend/component/">
            
                    
                    コンポーネントの分割
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.3" data-path="../todo/frontend/api/">
            
                <a href="../todo/frontend/api/">
            
                    
                    REST APIクライアントの作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.4" data-path="../todo/frontend/cors/">
            
                <a href="../todo/frontend/cors/">
            
                    
                    CORSの設定
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.5" data-path="../todo/frontend/mock/">
            
                <a href="../todo/frontend/mock/">
            
                    
                    モックサーバの起動
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.6" data-path="../todo/frontend/todo-list/">
            
                <a href="../todo/frontend/todo-list/">
            
                    
                    ToDoの一覧表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.7" data-path="../todo/frontend/todo-add/">
            
                <a href="../todo/frontend/todo-add/">
            
                    
                    ToDoの登録
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.8" data-path="../todo/frontend/todo-update/">
            
                <a href="../todo/frontend/todo-update/">
            
                    
                    ToDo状態の更新
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.9" data-path="../todo/frontend/todo-filter/">
            
                <a href="../todo/frontend/todo-filter/">
            
                    
                    ToDo一覧の絞り込み
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../todo/backend/">
            
                <a href="../todo/backend/">
            
                    
                    バックエンド
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="../todo/backend/todo-list/">
            
                <a href="../todo/backend/todo-list/">
            
                    
                    ToDo一覧取得のREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="../todo/backend/todo-add/">
            
                <a href="../todo/backend/todo-add/">
            
                    
                    ToDo登録のREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.3" data-path="../todo/backend/todo-update/">
            
                <a href="../todo/backend/todo-update/">
            
                    
                    ToDo状態更新のREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.4" data-path="../todo/backend/cors/">
            
                <a href="../todo/backend/cors/">
            
                    
                    CORSの設定
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../todo/e2e/">
            
                <a href="../todo/e2e/">
            
                    
                    動作確認
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../todo-delete/">
            
                <a href="../todo-delete/">
            
                    
                    ToDoを削除する（演習）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../auth/">
            
                <a href="../auth/">
            
                    
                    ユーザー認証の実装
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../auth/frontend/">
            
                <a href="../auth/frontend/">
            
                    
                    フロントエンド
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="../auth/frontend/page/">
            
                <a href="../auth/frontend/page/">
            
                    
                    ページ外観の作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.2" data-path="../auth/frontend/routing/">
            
                <a href="../auth/frontend/routing/">
            
                    
                    ルーティングの設定
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.3" data-path="../auth/frontend/context/">
            
                <a href="../auth/frontend/context/">
            
                    
                    ユーザーコンテクストの作成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.4" data-path="../auth/frontend/header/">
            
                <a href="../auth/frontend/header/">
            
                    
                    ナビゲーションメニューの切替
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.5" data-path="../auth/frontend/signup/">
            
                <a href="../auth/frontend/signup/">
            
                    
                    サインアップ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.6" data-path="../auth/frontend/login/">
            
                <a href="../auth/frontend/login/">
            
                    
                    ログイン
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.1.7" data-path="../auth/frontend/logout/">
            
                <a href="../auth/frontend/logout/">
            
                    
                    ログアウト
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../auth/backend/">
            
                <a href="../auth/backend/">
            
                    
                    バックエンド
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="../auth/backend/signup/">
            
                <a href="../auth/backend/signup/">
            
                    
                    サインアップのREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.2" data-path="../auth/backend/login/">
            
                <a href="../auth/backend/login/">
            
                    
                    ログインのREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.3" data-path="../auth/backend/logout/">
            
                <a href="../auth/backend/logout/">
            
                    
                    ログアウトのREST API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.4" data-path="../auth/backend/check/">
            
                <a href="../auth/backend/check/">
            
                    
                    REST APIへのアクセス制限
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2.5" data-path="../auth/backend/todo/">
            
                <a href="../auth/backend/todo/">
            
                    
                    ToDo管理でのユーザー取得
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../auth/e2e/">
            
                <a href="../auth/e2e/">
            
                    
                    動作確認
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.9" data-path="./">
            
                <a href="./">
            
                    
                    CSRF対策
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CSRF対策</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="csrf対策"><a name="csrf対策" class="plugin-anchor" href="#csrf対策"><i class="fa fa-link" aria-hidden="true"></i></a>CSRF対策</h1>
<p>REST API一覧の説明時にも紹介しましたが、Nablarchでは、クロスサイト・リクエスト・フォージェリ（以下CSRF）に対策するための機能が提供されています。（参考：<a href="https://www.ipa.go.jp/security/vuln/websecurity-HTML-1_6.html" target="_blank">CSRF | 安全なウェブサイトの作り方</a>）</p>
<p>CSRFトークンを発行してリクエスト毎にサーバーサイド側で保持してるCSRFトークンと突き合わせる方式であり、CSRFトークンを発行するためのユーティリティと、CSRFトークンを検証するためのハンドラが提供されています。（参考：<a href="https://nablarch.github.io/docs/5u18/doc/application_framework/application_framework/handlers/web/csrf_token_verification_handler.html" target="_blank">CSRFトークン検証ハンドラ | Nablarch</a>）</p>
<p>ここでは、CSRF対策を実現するために、バックエンドでCSRFトークンを取得するREST APIを提供し、フロントエンドからはREST APIで取得したCSRFトークンを使用するように実装していきます。</p>
<h2 id="バックエンド"><a name="バックエンド" class="plugin-anchor" href="#バックエンド"><i class="fa fa-link" aria-hidden="true"></i></a>バックエンド</h2>
<p>example-chatのバックエンドでも同様の実装をしているため、その実装を流用します。</p>
<p>バックエンドでは、CSRFトークンを取得するREST APIと、それを検証するためのハンドラを実装します。</p>
<h3 id="csrfトークンを取得するrest-apiの作成"><a name="csrfトークンを取得するrest-apiの作成" class="plugin-anchor" href="#csrfトークンを取得するrest-apiの作成"><i class="fa fa-link" aria-hidden="true"></i></a>CSRFトークンを取得するREST APIの作成</h3>
<p>CSRFトークンを取得するREST APIについては、example-chatの<code>com.example.presentation.restapi.system.CsrfTokenAction</code>クラスで同様の実装をしているため、このクラスをコピーして持ってきます。</p>
<h3 id="csrfトークン検証ハンドラの設定"><a name="csrfトークン検証ハンドラの設定" class="plugin-anchor" href="#csrfトークン検証ハンドラの設定"><i class="fa fa-link" aria-hidden="true"></i></a>CSRFトークン検証ハンドラの設定</h3>
<p>CSRFトークンを検証するハンドラについては、Nablarchから提供されているため、これもコンポーネント定義に追加します。CSRFトークンを検証するハンドラではセッションを使用するため、セッション変数保存ハンドラ（ここでは<code>sessionStoreHandler</code>）より後で実行されるように定義します。</p>
<pre><code class="lang-xml"><span class="hljs-comment">&lt;!-- CSRFトークン検証ハンドラ --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;csrfTokenVerificationHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nablarch.fw.web.handler.CsrfTokenVerificationHandler&quot;</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;webFrontController&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nablarch.fw.web.servlet.WebFrontController&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handlerQueue&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
...
        <span class="hljs-tag">&lt;<span class="hljs-name">component-ref</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sessionStoreHandler&quot;</span> /&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">component-ref</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;threadContextHandler&quot;</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- CSRFトークン検証ハンドラ --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">component-ref</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;csrfTokenVerificationHandler&quot;</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">component-ref</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dbConnectionManagementHandler&quot;</span>/&gt;</span>
...
    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
</code></pre>
<h3 id="ログインチェックハンドラの修正"><a name="ログインチェックハンドラの修正" class="plugin-anchor" href="#ログインチェックハンドラの修正"><i class="fa fa-link" aria-hidden="true"></i></a>ログインチェックハンドラの修正</h3>
<p>CSRFトークンを取得するREST APIは、ログインしていなくてもアクセスできる必要があります。ログインしていなくてもアクセスできるパスは、ユーザー認証の実装時に作成した<code>com.example.system.nablarch.handler.LoginCheckHandler</code>クラスのコンストラクタで設定しているため、<code>/api/csrf_token</code>のパスを追加します。</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LoginCheckHandler</span><span class="hljs-params">()</span> </span>{
    whitePatterns
            .add(<span class="hljs-string">&quot;/api/signup&quot;</span>, HttpMethod.POST)
            .add(<span class="hljs-string">&quot;/api/login&quot;</span>, HttpMethod.POST)
            .add(<span class="hljs-string">&quot;/api/csrf_token&quot;</span>, HttpMethod.GET);
}
</code></pre>
<h3 id="バックエンドのテスト"><a name="バックエンドのテスト" class="plugin-anchor" href="#バックエンドのテスト"><i class="fa fa-link" aria-hidden="true"></i></a>バックエンドのテスト</h3>
<p>次に、バックエンドのテストを実行してみます。</p>
<pre><code>mvn test
</code></pre><p>すると、更新系の操作をするREST APIのテストが失敗します。これは、CSRFトークン検証ハンドラにより、リクエスト時にCSRFトークンが無ければ、ステータスコードが<code>400 Bad Request</code>のエラーレスポンスとして返却されるためです。</p>
<p>そのため、テスト時にCSRFトークンを使用するように、テストクラスを修正します。</p>
<p>CSRFトークンを使用するには、先ほど実装したREST APIを使用してCSRFトークンとHTTPヘッダ属性名を取得し、リクエスト時のHTTPヘッダに設定する必要があります。</p>
<p>まず、テストクラスに次のようなprivateメソッドを実装します。</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">attachCsrfToken</span><span class="hljs-params">(RestMockHttpRequest request, ExecutionContext context)</span> </span>{
    HttpResponse response = sendRequest(get(<span class="hljs-string">&quot;/api/csrf_token&quot;</span>));
    assertStatusCode(<span class="hljs-string">&quot;CSRFトークンの取得&quot;</span>, HttpResponse.Status.OK, response);

    String json = response.getBodyString();
    String name = JsonPath.read(json, <span class="hljs-string">&quot;$.csrfTokenHeaderName&quot;</span>);
    String value = JsonPath.read(json, <span class="hljs-string">&quot;$.csrfTokenValue&quot;</span>);

    request.setHeader(name, value);

    WebConfig webConfig = WebConfigFinder.getWebConfig();
    String storedVarName = webConfig.getCsrfTokenSessionStoredVarName();
    String storeName = webConfig.getCsrfTokenSavedStoreName();
    <span class="hljs-keyword">if</span> (storeName != <span class="hljs-keyword">null</span>) {
        SessionUtil.put(context, storedVarName, value, storeName);
    } <span class="hljs-keyword">else</span> {
        SessionUtil.put(context, storedVarName, value);
    }
}
</code></pre>
<p>このメソッドでは、CSRFトークンを取得するREST APIを呼び出し、引数のリクエストオブジェクトへの設定と、サーバーサイドで比較元が保存されるセッションストアへの設定を実装しています。<code>ExecutionContext</code>を使用したセッションストアへの設定については、ユーザー認証でのテストクラスへの実装と同様に実装します。</p>
<p>各REST APIのテストで、REST APIにアクセスする前にこの<code>attachCsrfToken</code>メソッドを呼び出すように修正します。</p>
<p>例えばサインアップのテストであれば、次のように修正します。</p>
<pre><code class="lang-java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> RESTAPIでサインアップできる() {
    ExecutionContext executionContext = <span class="hljs-keyword">new</span> ExecutionContext();
    RestMockHttpRequest request = post(<span class="hljs-string">&quot;/api/signup&quot;</span>)
            .setHeader(<span class="hljs-string">&quot;Content-Type&quot;</span>, MediaType.APPLICATION_JSON)
            .setBody(Map.of(
                    <span class="hljs-string">&quot;userName&quot;</span>, <span class="hljs-string">&quot;signup-test&quot;</span>,
                    <span class="hljs-string">&quot;password&quot;</span>, <span class="hljs-string">&quot;pass&quot;</span>));
    attachCsrfToken(request, executionContext);

    HttpResponse response = sendRequestWithContext(request, executionContext);
...
</code></pre>
<p>例えばログアウトのようにユーザーIDを設定しているテストであれば、次のように修正します。</p>
<pre><code class="lang-java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> RESTAPIでログアウトできる() <span class="hljs-keyword">throws</span> Exception {
    ExecutionContext executionContext = <span class="hljs-keyword">new</span> ExecutionContext();
    SessionUtil.put(executionContext, <span class="hljs-string">&quot;user.id&quot;</span>, <span class="hljs-string">&quot;1010&quot;</span>);

    RestMockHttpRequest request = post(<span class="hljs-string">&quot;/api/logout&quot;</span>);
    attachCsrfToken(request, executionContext);

    HttpResponse response = sendRequestWithContext(request, executionContext);
...
</code></pre>
<p>各REST APIのテストで同様の実装をすると、テストが成功します。</p>
<p>これでバックエンドの実装は完了です。</p>
<h2 id="フロントエンド"><a name="フロントエンド" class="plugin-anchor" href="#フロントエンド"><i class="fa fa-link" aria-hidden="true"></i></a>フロントエンド</h2>
<p>続いて、フロントエンドを実装します。</p>
<h3 id="rest-apiクライアントへのcsrfトークン組込"><a name="rest-apiクライアントへのcsrfトークン組込" class="plugin-anchor" href="#rest-apiクライアントへのcsrfトークン組込"><i class="fa fa-link" aria-hidden="true"></i></a>REST APIクライアントへのCSRFトークン組込</h3>
<p>生成したREST APIクライアントのラッパーを実装した<code>BackendService.ts</code>に、CSRFトークンを使用するための実装を追加します。</p>
<p><code>src/backend/BackendService.ts</code></p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> {
  ...
  FetchParams,
  HTTPMethod,
  RequestContext
} <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./generated-rest-client&apos;</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CsrfTokenAttachment</span> <span class="hljs-title">implements</span> <span class="hljs-title">Middleware</span> </span>{

  private readonly targetMethod: ReadonlyArray&lt;HTTPMethod&gt; = [<span class="hljs-string">&apos;POST&apos;</span>, <span class="hljs-string">&apos;PUT&apos;</span>, <span class="hljs-string">&apos;DELETE&apos;</span>, <span class="hljs-string">&apos;PATCH&apos;</span>];
  private headerName = <span class="hljs-string">&apos;&apos;</span>;
  private tokenValue = <span class="hljs-string">&apos;&apos;</span>;

  <span class="hljs-function"><span class="hljs-title">setCsrfToken</span>(<span class="hljs-params">headerName: string, tokenValue: string</span>)</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;setCsrfToken:&apos;</span>, headerName, tokenValue);
    <span class="hljs-built_in">this</span>.headerName = headerName;
    <span class="hljs-built_in">this</span>.tokenValue = tokenValue;
  }

  pre = <span class="hljs-keyword">async</span> (context: RequestContext): <span class="hljs-built_in">Promise</span>&lt;FetchParams | <span class="hljs-keyword">void</span>&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.headerName || !<span class="hljs-built_in">this</span>.targetMethod.includes(context.init.method <span class="hljs-keyword">as</span> HTTPMethod)) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;attach csrf token:&apos;</span>, <span class="hljs-built_in">this</span>.headerName, <span class="hljs-built_in">this</span>.tokenValue);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">url</span>: context.url,
      <span class="hljs-attr">init</span>: {
        ...context.init,
        <span class="hljs-attr">headers</span> : {
          ...context.init.headers,
          [<span class="hljs-built_in">this</span>.headerName]: <span class="hljs-built_in">this</span>.tokenValue
        }
      }
    };
  }
}

<span class="hljs-keyword">const</span> csrfTokenAttachment = <span class="hljs-keyword">new</span> CsrfTokenAttachment();

<span class="hljs-keyword">const</span> configuration = <span class="hljs-keyword">new</span> Configuration({
  <span class="hljs-attr">middleware</span>: [csrfTokenAttachment, corsHandler, requestLogger]
});

...

<span class="hljs-keyword">const</span> refreshCsrfToken = <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> usersApi.getCsrfToken();
  csrfTokenAttachment.setCsrfToken(response.csrfTokenHeaderName, response.csrfTokenValue);
};

...

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> BackendService = {
...
  refreshCsrfToken
};
</code></pre>
<p>すでに説明したとおり、生成したREST APIのクライアントコードでは、Middlewareと呼ばれる部品を作成することで、リクエストやレスポンスに対する共通的な処理を実装することができます。</p>
<p>まず、CSRFトークンをヘッダに設定する<code>CsrfTokenAttachment</code>クラスを、Middlewareとして実装します。（CSRFトークンを状態として保持しやすくするよう、クラスとして実装します）</p>
<p>Middlewareに追加するため、<code>CsrfTokenAttachment</code>のオブジェクトを生成し、<code>middleware</code>プロパティに追加します。</p>
<p>次に、CSRFトークン取得のREST APIを呼び出して<code>CsrfTokenAttachment</code>に設定する<code>refreshCsrfToken</code>関数を実装します。CSRFトークンはセッションストアに紐付いており、セッションが切り替わるタイミングでCSRFトークンも変更になるため、ログインやログアウト等のセッション切替タイミングで、この関数を実行してCSRFトークンを最新化します。</p>
<h3 id="アプリ起動時のcsrfトークン設定"><a name="アプリ起動時のcsrfトークン設定" class="plugin-anchor" href="#アプリ起動時のcsrfトークン設定"><i class="fa fa-link" aria-hidden="true"></i></a>アプリ起動時のCSRFトークン設定</h3>
<p>アプリ起動時にCSRFトークンを設定するため、<code>App</code>コンポーネントで先ほど作成した<code>refreshCsrfToken</code>関数を実行するように実装します。</p>
<pre><code class="lang-jsx"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> [initialized, setInitialized] = useState(<span class="hljs-literal">false</span>);

  useEffect(<span class="hljs-function">() =&gt;</span> {
    BackendService.refreshCsrfToken()
      .finally(<span class="hljs-function">() =&gt;</span> setInitialized(<span class="hljs-literal">true</span>));
  }, []);

  <span class="hljs-keyword">if</span> (!initialized) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Fragment</span> /&gt;</span></span>
    );
  }
...
</code></pre>
<p><code>refreshCsrfToken</code>関数によるCSRFトークン取得が完了するまでは、他のコンポーネントを処理したくないため、それを制御するためのフラグとして<code>initialized</code>stateを作成します。<code>refreshCsrfToken</code>の処理が終わるまでは、JSXで空要素を返すようにし、<code>refreshCsrfToken</code>の処理が完了して<code>initialized</code>が<code>true</code>になったタイミングで、今までと同様のコンポーネント処理を実行するようにします。</p>
<h3 id="ログイン・ログアウト時のcsrfトークン設定"><a name="ログイン・ログアウト時のcsrfトークン設定" class="plugin-anchor" href="#ログイン・ログアウト時のcsrfトークン設定"><i class="fa fa-link" aria-hidden="true"></i></a>ログイン・ログアウト時のCSRFトークン設定</h3>
<p>ログイン、ログアウト時に、セッションを破棄して新しく開始するようにしているため、ユーザーコンテクストにある<code>login</code>、<code>logout</code>関数内で、先ほど作成した<code>refreshCsrfToken</code>関数を実行するように実装します。</p>
<pre><code class="lang-jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> UserContextProvider: React.FC = <span class="hljs-function">(<span class="hljs-params">{ children }</span>) =&gt;</span> {
  ...
  <span class="hljs-keyword">const</span> contextValue: ContextValueType = {
    ...
    <span class="hljs-attr">login</span>: <span class="hljs-keyword">async</span> (userName, password) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> BackendService.login(userName, password);
        <span class="hljs-keyword">await</span> BackendService.refreshCsrfToken();
        setUserName(userName);
        ...
    },
    <span class="hljs-attr">logout</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> BackendService.logout();
      <span class="hljs-keyword">await</span> BackendService.refreshCsrfToken();
      setUserName(<span class="hljs-string">&apos;&apos;</span>);
      ...
</code></pre>
<p>これで、フロントエンドの実装は完了です。</p>
<h2 id="動作確認"><a name="動作確認" class="plugin-anchor" href="#動作確認"><i class="fa fa-link" aria-hidden="true"></i></a>動作確認</h2>
<p>いままでと同じように、フロントエンドアプリとバックエンドアプリを起動し、動作を確認します。</p>
<p>内部的な処理であるため、ページの動作や見た目については、何も影響がありません。</p>
<p>CSRFトークンの取得や設定時には<code>console.log</code>でログを出力していますので、ブラウザの開発者ツールでコンソールを確認してみましょう。次のようなログが出力され、正常に動作していることが確認できます。</p>
<pre><code>&gt;&gt; GET /api/csrf_token 
Object { method: &quot;GET&quot;, headers: {}, body: undefined, credentials: undefined }
</code></pre><pre><code>&lt;&lt; 200 /api/csrf_token 
Response { type: &quot;basic&quot;, url: &quot;http://localhost:3000/api/csrf_token&quot;, redirected: false, status: 200, ok: true, statusText: &quot;OK&quot;, headers: Headers, body: ReadableStream, bodyUsed: false }
</code></pre><pre><code>setCsrfToken: X-CSRF-TOKEN cb5a3ec0-c32f-47f7-b4a0-149f8ba41341
</code></pre><p>これで、CSRF対策の実装は完了です。</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../auth/e2e/" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 動作確認">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CSRF対策","level":"1.9","depth":1,"previous":{"title":"動作確認","level":"1.8.3","depth":2,"path":"auth/e2e/README.md","ref":"auth/e2e/README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["page-toc-button","anchors","hints","search-pro-fixed","-lunr","-search","hide-published-with"],"root":"./source","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"anchors":{},"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"search-pro-fixed":{},"hide-published-with":{},"highlight":{},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"index.md","glossary":"GLOSSARY.md","summary":"README.md"},"variables":{},"gitbook":"*"},"file":{"path":"csrf/README.md","mtime":"2023-07-24T02:52:18.365Z","type":"markdown"},"gitbook":{"version":"3.6.19","time":"2023-07-24T02:53:26.524Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro-fixed/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro-fixed/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

